services:
  castr:
    # Use pre-built image from registry (recommended for production)
    image: ghcr.io/joezombie/castr:latest
    # Or build locally (for development):
    # build:
    #   context: .
    #   dockerfile: Dockerfile
    container_name: castr
    expose:
      - "8080"
    # Uncomment if not using Traefik:
    # ports:
    #   - "5000:8080"
    volumes:
      # Mount your media directories here
      - /mnt/user/Stuff/Podcasts:/Podcasts:rw
      # Persist central database (recommended)
      - castr-data:/data:rw
      # Add additional podcast directories as needed:
      # - /path/to/podcast:/path/to/podcast:ro
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      # Configure forwarded headers for reverse proxy
      - ASPNETCORE_FORWARDEDHEADERS_ENABLED=true

      # Dashboard authentication (REQUIRED - change these!)
      - Dashboard__Username=admin
      - Dashboard__Password=CHANGE_ME_TO_SECURE_PASSWORD

      # Database configuration (optional, defaults shown)
      # Supported providers: SQLite, PostgreSQL, SQLServer, MySQL
      - Database__Provider=SQLite
      - Database__ConnectionString=Data Source=/data/castr.db
    networks:
      - traefik
    labels:
      # Enable Traefik for this container
      - "traefik.enable=true"

      # HTTP router configuration
      - "traefik.http.routers.castr.rule=Host(`podcast.example.com`)"
      - "traefik.http.routers.castr.entrypoints=websecure"
      - "traefik.http.routers.castr.tls=true"
      - "traefik.http.routers.castr.tls.certresolver=letsencrypt"

      # Service configuration
      - "traefik.http.services.castr.loadbalancer.server.port=8080"

      # Optional: Middleware for additional security
      # - "traefik.http.routers.castr.middlewares=castr-headers"
      # - "traefik.http.middlewares.castr-headers.headers.customResponseHeaders.X-Robots-Tag=noindex,nofollow"

      # Optional: HTTP to HTTPS redirect
      - "traefik.http.routers.castr-http.rule=Host(`podcast.example.com`)"
      - "traefik.http.routers.castr-http.entrypoints=web"
      - "traefik.http.routers.castr-http.middlewares=redirect-to-https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
    restart: unless-stopped

volumes:
  castr-data:
    # Named volume for central database persistence

networks:
  traefik:
    external: true
