@inherits LayoutComponentBase
@inject ISettingsService SettingsService
@inject ILogger<MainLayout> Logger
@implements IDisposable

<MudThemeProvider Theme="_theme" @bind-IsDarkMode="_isDarkMode" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Elevation="1">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@ToggleDrawer" />
        <MudText Typo="Typo.h5" Class="ml-3">Castr</MudText>
        <MudSpacer />
        <MudIconButton Icon="@Icons.Material.Filled.Brightness4" Color="Color.Inherit" OnClick="@ToggleDarkMode" />
    </MudAppBar>
    <MudDrawer Open="_drawerOpen" OpenChanged="OnDrawerOpenChanged" ClipMode="DrawerClipMode.Always" Elevation="2" Variant="@DrawerVariant.Responsive" Breakpoint="Breakpoint.Md">
        <CascadingValue Value="@CloseDrawer">
            <NavMenu />
        </CascadingValue>
    </MudDrawer>
    <MudMainContent>
        <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>

@code {
    private bool _drawerOpen = false;
    private bool _isDarkMode = true;
    private MudTheme _theme = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var settings = await SettingsService.GetSettingsAsync();
            _isDarkMode = settings.DarkMode;
            Logger.LogDebug("Loaded dark mode preference: {DarkMode}", _isDarkMode);
            
            // Subscribe to settings changes
            SettingsService.SettingsChanged += OnSettingsChanged;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load settings");
        }
    }

    private void ToggleDrawer()
    {
        _drawerOpen = !_drawerOpen;
    }

    private void OnDrawerOpenChanged(bool value)
    {
        _drawerOpen = value;
    }

    private void CloseDrawer()
    {
        _drawerOpen = false;
    }

    private void ToggleDarkMode()
    {
        _isDarkMode = !_isDarkMode;
        
        // Save preference asynchronously without awaiting (fire-and-forget with error handling)
        _ = Task.Run(async () =>
        {
            try
            {
                var settings = await SettingsService.GetSettingsAsync();
                // Create new instance to avoid mutating cached object
                var updatedSettings = new UserSettings
                {
                    Id = settings.Id,
                    DarkMode = _isDarkMode,
                    DefaultPollingIntervalMinutes = settings.DefaultPollingIntervalMinutes,
                    DefaultAudioQuality = settings.DefaultAudioQuality,
                    DefaultLanguage = settings.DefaultLanguage,
                    DefaultFileExtensions = settings.DefaultFileExtensions,
                    DefaultCategory = settings.DefaultCategory,
                    UpdatedAt = settings.UpdatedAt
                };
                await SettingsService.SaveSettingsAsync(updatedSettings);
                Logger.LogDebug("Dark mode preference saved: {DarkMode}", _isDarkMode);
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Failed to save dark mode preference");
            }
        });
    }
    
    private void OnSettingsChanged(object? sender, UserSettings settings)
    {
        _isDarkMode = settings.DarkMode;
        InvokeAsync(StateHasChanged);
    }
    
    public void Dispose()
    {
        SettingsService.SettingsChanged -= OnSettingsChanged;
    }
}

